name: GMLoader-Next Build for Miyoo A30

on:
  workflow_dispatch:
  push:
    branches: [ "master", "main" ]
    paths-ignore:
      - '**/README.md'
  pull_request:
    branches: [ "master", "main" ]
    paths-ignore:
      - '**/README.md'

jobs:
  build-a30:
    name: Build A30 Toolchain Docker
    runs-on: ubuntu-24.04

    steps:
      - name: ðŸ”¹ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ‹ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ“¦ Build Miyoo A30 Toolchain Docker image
        run: |
          echo "==> Construindo imagem do Docker..."
          docker build -t miyooa30-toolchain -f Dockerfile .

      - name: ðŸ§± Criar container e montar workspace
        run: |
          echo "==> Criando container temporÃ¡rio..."
          docker create -it --name a30build -v ${{ github.workspace }}:/workspace miyooa30-toolchain /bin/bash

      - name: â–¶ï¸ Rodar build.sh dentro do container
        run: |
          echo "==> Rodando build.sh dentro do container..."
          docker start -a a30build
          docker exec a30build bash -c "cd /workspace && chmod +x build.sh && ./build.sh || echo 'âš ï¸ build.sh retornou erro'"

      - name: ðŸ“ Copiar artefatos compilados
        if: always()
        run: |
          echo "==> Copiando artefatos da build..."
          mkdir -p output
          docker cp a30build:/workspace/build ./output || true
          docker cp a30build:/workspace/bin ./output || true

      - name: ðŸ§¹ Limpar container
        if: always()
        run: |
          docker rm -f a30build || true
          docker image rm miyooa30-toolchain || true

      - name: ðŸ“¦ Upload dos artefatos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: GMLoader-A30-Build
          path: output/
